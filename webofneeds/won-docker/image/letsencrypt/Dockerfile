# fix java version here until the following issue is resolved: https://github.com/researchstudio-sat/webofneeds/issues/1229
FROM openjdk:8u121-jdk

# install certbot
# next 3 and a half lines as per https://unix.stackexchange.com/questions/508724/failed-to-fetch-jessie-backports-repository (second answer)
RUN echo "deb [check-valid-until=no] http://cdn-fastly.deb.debian.org/debian jessie main" > /etc/apt/sources.list.d/jessie.list
RUN echo "deb [check-valid-until=no] http://archive.debian.org/debian jessie-backports main" > /etc/apt/sources.list.d/jessie-backports.list
RUN sed -i '/deb http:\/\/deb.debian.org\/debian jessie-updates main/d' /etc/apt/sources.list
RUN apt-get -o Acquire::Check-Valid-Until=false update && apt-get -o Acquire::Check-Valid-Until=false install -y certbot -t jessie-backports dos2unix

# main directory where the certificates are generated. This directory should be mounted to the host since other
# directories inside (e.g. "live") use symlinks which should not be broken by mounting
ENV main_dir="/etc/letsencrypt"

# webroot directory which is used for the letsencrypt acme challenge, this is mounted from the nginx web proxy
ENV webroot_dir="/usr/share/nginx/html"

# mail address that gets informed when the certificate is about to run out
ENV certificate_email=florian.kleedorfer@researchstudio.at

# first entry is the certificate name used by --cert-name, option of certbot command
ENV domain_params="matchat.org -d matchat.org -d www.matchat.org -d node.matchat.org -d ownerblue.master.matchat.org -d ownergreen.master.matchat.org -d nodeblue.master.matchat.org -d nodegreen.master.matchat.org -d hackathon.matchat.org -d hackathonnode.matchat.org -d spoco.me"

# java key store password
ENV key_store_password=changeit

# the certificate files "privkey.pem" and "fullchain.pem" are generated by letsencrypt certbot in the folder "live"
# and subfolder "matchat.org" (as symlinks that point to an archive folder). The certificate is valid for the domain
# "matchat.org" and the subdomains "www.matchat.org" and "node.matchat.org" (see certificate-request-and-renew.sh)
ENV key_pem_file="$main_dir/live/matchat.org/privkey.pem"
ENV cert_pem_file="$main_dir/live/matchat.org/fullchain.pem"

# the java key store file is generated from the .pem files in the same folder.
ENV pfx_store_file="$main_dir/live/matchat.org/t-key-cert.pfx"
ENV jks_store_file="$main_dir/live/matchat.org/t-keystore.jks"

ADD certificate-request-and-renew.sh /usr/local/bin/certificate-request-and-renew.sh
RUN chmod +x /usr/local/bin/certificate-request-and-renew.sh
RUN dos2unix /usr/local/bin/certificate-request-and-renew.sh

# execute cron to keep container running
#RUN touch /var/log/cron.log
#CMD cron && tail -f /var/log/cron.log

# try to renew letsencrypt certificates
# Changed from 'RUN' command as this is not a command to change the container but the command to be executed when the container runs
ENTRYPOINT /usr/local/bin/certificate-request-and-renew.sh
