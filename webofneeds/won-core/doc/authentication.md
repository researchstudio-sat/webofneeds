#Authentication and related configurations

* [Authentication at Linked Data level](#authentication-at-linked-data-level)
* [Authentication at Application level](#authentication-at-application-level)
* [Client and Server security](#client-and-server-security)
  * [Java configuration](#java-configuration)
  * [Server-side security configurations](#server-side-security-configurations)
    * [Configuring Tomcat](#configuring-tomcat)
    * [Configuring Node and Owner web applications](#configuring-node-and-owner-web-applications)
    * [Configuring JMS broker](#configuring-jms-broker)
  * [Client-side security configurations](#client-side-security-configurations)
    * [Configuring client keystores](#configuring-client-keystores)
    * [Initiating TLS protected connections from client](#initiating-tls-protected-connections-from-client)
* [Truststores and trust strategies](#truststores-and-trust-strategies)


##Authentication at Linked Data level

On the Linked Data level, the authentication serves following purposes in WoN:
* Authentication of the data itself - data authenticity
*	Authentication of the Atom or Node accessing a linked data resource with restricted access

Data authenticity is ensured by using [digital signatures](message-signatures.md). Here, the data creator's 
should have a [web identity](web-identity.md) and its public key 
used for verification is obtained via accessing the creator's 
resource linked data and extracting it from there. Then this public key is used to verify the authenticity of the data
 generated by Atom or Node.

Authentication of a WoN entity (Atom or Node) when accessing a WoN linked data resource with 
[restricted access](access-control.md) is ensured via 
[WebID-TLS protocol](https://www.w3.org/2005/Incubator/webid/spec/tls/). Here, the server verifies if a provided
by the accessor certificate really corresponds to the WebID of a party for which the access is granted.

##Authentication at Application level

On the application level, the authentication serves the following purposes in WoN:
* the data exchange is performed with the eligible servers/applications and the data is not eavesdropped by 
unauthorized parties

Authentication at Application level is ensured by applying the TLS protocol over all the 
[data transmission channels](data-channels.md) used in WoN. Here, the servers on which the applications run (Node, 
Owner) should have certificates. The TLS protocol will perform authentication. Additionally, the servers 
should be configured to be able to require client authentication. The serving as client applications 
should provide its certificate and as well, TLS protocol will perform client authentication.

##Client and Server security
Node and Owner can serve as both client and server. Matcher, currently, only serves as client in WoN. Atoms are also 
clients, and in the current architecture, since their key management is done in the Owner Application, are represented
by the Owner acting as Node's client on behalf of those Atoms. 

For example, when WoN Linked Data is being requested from the Node, or when an Owner application sends a WoN message to
the Node on behalf of its user's Atom for publishing and processing, the Node serves as a server and the Owner as 
client. When the Node itself, after processing this message, has to send it to another Node for further processing, 
this first Node servers as a client of that another Node. The Owner Application serves as a server when, for example,
the user (from browser) sends to the Owner application a WoN message related to his Atom.

###Java configuration
Some countries have restrictions on the permitted key strength used in encryption algorithms. Due to this, JDK has a 
deliberate key size restriction by default: an encryption with key more than 128 bits cannot be performed resulting 
in error:  ```java.security.InvalidKeyException: Illegal key size or default parameters. ```

Since our server and client keys are bigger than 128 bits, we need to install an 
[unlimited strength policy](http://www.oracle.com/technetwork/java/javase/downloads/jce8-download-2133166.html) 
indicating no restrictions on cryptographic strengths, for eligible countries (which is most countries). 
The JCE framework will enforce the restrictions specified in the installed jurisdiction policy files.

###Server-side security configurations
In order to authenticate the applications acting as servers, and applications and (in some cases) entities acting as 
clients, the servers have to be configured to support TLS, to provide their certificates to the clients, to apply
appropriate trust strategy and to be able to require client authentication. In WoN architecture, this concerns the 
Node and Owner web applications server, Tomcat. The Node and Owner web applications that run on that server, also 
have to be configured to use this TLS support. This configures [HTTPS channels in WoN](data-channels.md).

Additionally, since the message exchange in our implementation is 
done via JMS, the Node's broker (corresponds to server-side functionality in JMS) should be configured to support 
TLS, to provide their certificates to the clients, to apply appropriate trust strategy and to require 
client authentication. This configures [JMS channels in WoN](data-channels.md).

####Configuring Tomcat
In WoN reference implementation, Tomcat is used as a stand-alone web server on which Owner web application and Node web 
application run. The configuration below is therefore specific to Tomcat. We use 
[Tomcat 8.0.24](https://tomcat.apache.org/download-80.cgi) and 
[Java 8](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html) 
(using Java 8 provides the benefit that TLS1.2 will be used by default).

In order to provide Owner and Node as secure services, to which one can connect using HTTPS, the WoN servers have 
been configured:
* with server's key pair and corresponding certificate:
 *	for development purposes, such as in WoN reference implementation, self-signed certificate is used.
 *	make sure the common name (CN) in the certificate corresponds to the authority of the server (for development 
 	purposes when developing on one server, it can also be localhost).
 *	for production, it is advisable to get certificated from a recognized CA, at least for Owner web application. 
 Otherwise, if self-signed certificate is used for production, the users will be presented with warnings about unsafe
  connection to the server. For production we plan to obtain [Let's Encrypt](https://letsencrypt.org/) certificates 
  for our servers.
*	with APR connector for TLS:
 * referencing the certificate and keys above (they should be in PEM format) and specifying related password
 * setting client authentication to **wanted** - which provides for the flexibility: if a client provides 
 certificate - TLS verification will be applied by the server, if not - it is not applied. The application layer can 
 then use the results of server's client authentication/non-authentication.

This configuration should be done in Tomcat's server.xml file, i.e. node's server [server.xml](../../won-docker/wonnode/ssl/server.xml) and 
owner's server [server.xml](../../won-docker/owner/ssl/server.xml), - see  ```<Connector scheme="https" ...> ```
configuration. 
Application of [APR connector](https://tomcat.apache.org/tomcat-8.0-doc/apr.html) is necessary on the Node, because 
it provides the possibility to use **optionalNoCA** 
options, i.e. it makes it possible to use client verification when clients have self-signed certificates, which is 
the case for Atom and Node, and in WoN is applied during WebID-TLS verification when accessing Linked Data 
resources at the Node. APR implementation, in its turn, uses openssl native implementation by 
default. The default connector and its implementation used by Tomcat, as of current sate, does not provide such 
a possibility. Therefore, we use APR. Note, that in case of Owner web application, we don't require this functionality 
and the default Tomcat's https connector could also be used instead of APR.

Additionally, since we use [Bouncy Castle](https://www.bouncycastle.org/) as provider when dealing with clients keys 
and keystores, the bouncycastle libraries (as of current state, bcpkix-jdk15on-1.52.jar and bcprov-jdk15on-1.52.jar) 
should be added to Tomcat's lib folder. 

####Configuring Node and Owner web applications
*	Make sure a web application are deployed on the server that supports HTTPS (see e.g. Tomcat configuration above)
* Make sure those web applications do not load data from not HTTPS sources, including client-side, e.g., use 
https://maps.google.com/... instead of http://maps.google.com/...
* Configure those web application to only serve HTTPS:
 *	It is considered unsafe, if both safe and unsafe versions are available
 *	E.g., in WoN, Owner web application is configured via spring-security: 
 ```
     <intercept-url pattern="/**" requires-channel="https"/>
 ```
 *  E.g., In WoN, Node web application is configured via security constraint specified in web.xml:
 ```
     <security-constraint>
         <web-resource-collection>
             <web-resource-name>node-linked-data</web-resource-name>
             <url-pattern>/*</url-pattern>
         </web-resource-collection>
         <user-data-constraint>
             <transport-guarantee>CONFIDENTIAL</transport-guarantee>
         </user-data-constraint>
     </security-constraint>
```

####Configuring JMS broker

As a messaging channel, in WoN reference implementation we use JMS with ActiveMQ provider. In order to secure this 
channel with TLS, the broker has to be configured at the Node:
* Keystore of Broker at Node contains the same key pair and certificate that is used as Node's web server 
  certificate (see Tomcat configuration above). The format of the keystore for broker should be JKS format. We use 
  the same key pair, because of the way we implemented the TOFU trust for messaging - during the registration done 
  over HTTPS client and server exchange certificates and remember them; for the following connections, including 
  those over JMS the exchanged certificates are expected to be in the truststore. Therefore the certificate that we 
  obtain from the Node's web application server and those presented by the Node's Broker should be the same. The 
  keystore is configured in [node properties](../../conf/node.properties) by
   * activemq.broker.keystore - location of the keystore
   * activemq.broker.keystore.password - password to access the keystore 
*	Broker  [is specified](../../won-node/src/main/resources/spring/component/broker/activemq.xml) with
  * ssl transport connector with client authentication set to true. See  ```<transportConnector> ```.
  * custom key and trust manager, - key manager uses the keystore configured above, the custom TrustManager 
  implementation takes care that the certificates are trusted based on TOFU principle. 
  The custom trust manager is not necessary if we use trust strategy based on CA (in that case the trust store that 
  contains the CA certificate should be specified instead). See ```<sslContext>```.

 
 
###Client-side security configurations
When server requires the client authentication, the client has to be able to provide his eligible certificate and 
generally respond according to the TLS protocol. Therefore, the client-side should be able to establish TLS protected 
connections, be in a possession of a client certificate and apply appropriate trust strategy on a particular 
connection. In WoN the Owner, Node, Matcher and Atoms have their certificate. 


The Owner/Node/Matcher client certificate is provided over TLS when that Owner/Node/Matcher send a WoN message to 
another Node - on [JMS channels in WoN](data-channels.md).
When it is a first connection to that Node, the Owner/Node/Matcher first registers providing its certificate over TLS -
on [WoN HTTPS channel](data-channels.md).
 
The Atoms certificates are provided 
when a Message stored as a Linked Data on a Node is being accessed by that Atom (Owner application accesses it on 
behalf of Atom and provides that Atom's certificate, of course, only if the current user is eligible owner of that 
Atom) - on [WoN HTTPS channel](data-channels.md).
 
####Configuring client keystores
The keystore properties should be configured. These keystores are used to store clients' key pairs and certificates, 
i.e. those of Atoms, Owner client, Node client and Matcher client.

Keystore of Node is configured in [node properties](../../conf/node.properties) by

* keystore.password - password to access the keystore
* keystore.location - location of the keystore, if not found there - generated and saved there
* uri.prefix.resource - used as alias of the node's key and certificate


for Atoms and Owner, in [owner properties](../../conf/owner.properties) in

* keystore.password - password to access the keystore
* keystore.location - location of the keystore, if not found there - generated and saved there
* uri.prefix.resource - used as alias of the owner's key and certificate, the aliases of the atoms are their URIs


for Matcher, in [matcher properties](../../conf/matcher-service.properties) in

* keystore.password - password to access the keystore
* keystore.location - location of the keystore, if not found there - generated and saved there
* matcher.uri - used as alias of the matcher's key and certificate

####Initiating TLS protected connections from client
When establishing HTTPS connections, the client should be configured to perform TLS, including providing correct client 
certificate if asked, to apply certain trust strategy (the ground for client trusting or not the server it is 
connecting to). In WoN, 
[LinkedDataRestClientHttps](../../src/main/java/won/protocol/rest/LinkedDataRestClientHttps.java),
[LinkedDataRestBridge](../../src/main/java/won/protocol/rest/LinkedDataRestBridge.java) and
[RegistrationRestClientHttps](../../src/main/java/won/cryptography/service/RegistrationRestClientHttps.java)
are responsible for this. They should be configured by 
[WonTransmissionService](../../src/main/java/won/cryptography/service/WonTransmissionService.java)
Note, that currently used 
[implementation of WonTransmissionService](../../src/main/java/won/cryptography/service/DefaultSecurityWonTransmissionService.java)
is only appropriate for development; for production the applied trust strategies might need to be changed.

When establishing JMS connections, the client should be configured for TLS as well. In WoN, 
[MessagingContext](../../src/main/java/won/cryptography/ssl/MessagingContext.java)
is responsible for this, also configured by 
[WonTransmissionService](../../src/main/java/won/cryptography/service/WonTransmissionService.java)


### Truststores and trust strategies

Using TLS ensures the enpoints are authenticated as those announced in their certificates, but for the security of 
the connection it is also important that those authenticated endpoints do trust each other. If not - the connection 
should not be established. In WoN, different trust strategies and trust managers are used at different channels and 
endpoints. The client-side trust strategies to use for particular connection should be configured at the 
[WonTransmissionService](../../src/main/java/won/cryptography/service/WonTransmissionService.java). The server-side 
trust strategy (for the case the client authentication is required) is configured by Tomcat or web application, and at 
Broker configurations.

For example, in our Tomcat configuration we do not specify any trust strategy, but we specify for the node web 
application to apply the WebID-based trust for the clients when they access resources with restricted access.

Another example, the broker, specifies a Trust Manager, that trusts only those certificates already in its truststore.
This truststore is dynamically updated based on TOFU trust strategy applied during registration at 
Node (done over HTTPS) - the client and server exchange certificates and trust each other if its the first time they
establish a connection, they remember each other's certificates by putting them into that truststore. Therefore, all
following connections between the same entities require that the certificates to stay the same.

Therefore, the connections made from clients to the broker - message producer and consumer - use the same custom 
TrustManager implementation as the broker.

The HTTPS clients in WoN currently trust all the servers. This should be used only for development, for production it
is better to use whitelist-based, CA-based, WebID-based, or TOFU-based trust strategies.

The truststore properties should be configured. These truststores will be created when WoN applications are deployed 
and run for the first time.

Truststore of Node is configured in [node properties](../../conf/node.properties), of Owner in 
[owner properties](../../conf/owner.properties), of  Matcher, in 
[matcher properties](../../conf/matcher-service.properties) by:

* truststore.password - password to access the truststore
* truststore.location - location of the truststore, if not found there - generated and saved there
